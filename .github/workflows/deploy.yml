name: CI/CD Deploy Direct

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            src:
              - 'School Meal Review Platform/**'
              - 'backend.py'
              - 'Dockerfile.backend'
              - 'requirements.txt'
              - 'NEIS/**'
            config:
              - 'docker-compose.yml'

      - name: Build Frontend Image
        if: steps.changes.outputs.src == 'true'
        run: |
          echo "=== Building Frontend Image ==="
          echo "VITE_SUPABASE_URL is set: ${{ secrets.VITE_SUPABASE_URL != '' }}"
          echo "VITE_SUPABASE_ANON_KEY is set: ${{ secrets.VITE_SUPABASE_ANON_KEY != '' }}"
          docker build \
            --build-arg VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
            --build-arg VITE_SUPABASE_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            -t meal-frontend:latest \
            -f "School Meal Review Platform/Dockerfile" \
            "School Meal Review Platform"

      - name: Build Backend Image
        if: steps.changes.outputs.src == 'true'
        run: docker build -t meal-backend:latest -f Dockerfile.backend .

      - name: Save Backend Image
        if: steps.changes.outputs.src == 'true'
        run: docker save meal-backend:latest -o backend.tar

      - name: Save Frontend Image
        if: steps.changes.outputs.src == 'true'
        run: docker save meal-frontend:latest -o frontend.tar

      - name: Create Backend .env file
        run: |
          echo "NEIS_API_KEY=${{ secrets.NEIS_API_KEY }}" > .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env

      - name: Determine files to transfer
        id: transfer
        run: |
          if [ "${{ steps.changes.outputs.src }}" == "true" ]; then
            echo "files=docker-compose.yml,.env,backend.tar,frontend.tar" >> $GITHUB_OUTPUT
            echo "mode=full" >> $GITHUB_OUTPUT
          else
            echo "files=docker-compose.yml,.env" >> $GITHUB_OUTPUT
            echo "mode=partial" >> $GITHUB_OUTPUT
          fi

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT || '22' }}
          source: ${{ steps.transfer.outputs.files }}
          target: ${{ secrets.TARGET_DIR }}
          strip_components: 0

      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        env:
          DEPLOY_MODE: ${{ steps.transfer.outputs.mode }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT || '22' }}
          envs: DEPLOY_MODE
          script: |
            cd ${{ secrets.TARGET_DIR }}

            if [ "$DEPLOY_MODE" = "full" ]; then
              echo "=== Full Deployment Mode ==="
              
              # Stop existing containers
              echo "Stopping existing containers..."
              docker compose down

              # Remove old images to force using new ones
              echo "Removing old images..."
              docker rmi meal-backend:latest meal-frontend:latest || true

              # Load new images
              echo "Loading backend image..."
              docker load -i backend.tar
              echo "Loading frontend image..."
              docker load -i frontend.tar

              # Cleanup artifacts
              rm backend.tar frontend.tar
            else
              echo "=== Partial Update Mode (Config Only) ==="
            fi

            # Start services (Recovers state or updates config)
            echo "Starting services..."
            docker compose up -d

            # Show logs for debugging
            echo "=== Frontend container logs ==="
            docker logs incoding_meal --tail 50
            
            # Prune
            docker system prune -f